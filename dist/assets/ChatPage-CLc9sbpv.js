import{a as z,e as E,r,n as L,q as P,o as U,p as k,t as B,j as e,P as F,z as m,k as q,s as H,l as T,m as $,d as x,v as D,w as O}from"./index-Bz7pwbB9.js";import{u as Q}from"./useMutation-bJ9c7Hmc.js";import{d as V}from"./api-Bp1mAEYF.js";import{L as b,C as w,a as v,M as f,b as W,c as Y,A as _,S as G,R as J}from"./Card-D8tmHTuL.js";import{c as K,B as X}from"./Button-DxGI9h4D.js";import{I as Z}from"./image-Bp3tbxms.js";import"./user-BIVSRI51.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=K("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function ce(){const{userData:h,user:u}=z();E();const j=r.useRef(null),[l,g]=r.useState(""),[p,S]=r.useState([]),[C,y]=r.useState(!0),[M,N]=r.useState(!1),n=h==null?void 0:h.houseId;r.useEffect(()=>{if(!n)return;const s=L(O,"houses",n,"messages"),a=P(s,k("createdAt","desc"),U(100)),c=B(a,t=>{const i=t.docs.map(d=>({id:d.id,...d.data()})).reverse();S(i),y(!1)},t=>{console.error("Chat error:",t),y(!1)});return()=>c()},[n]),r.useEffect(()=>{var s;(s=j.current)==null||s.scrollIntoView({behavior:"smooth"})},[p]);const o=Q({mutationFn:s=>V.sendMessage(n,s),onError:s=>{m.error(s.message||"Failed to send message")}}),I=s=>{s.preventDefault(),l.trim()&&(o.mutate({text:l.trim(),type:"text"}),g(""))},R=async s=>{var c;const a=(c=s.target.files)==null?void 0:c[0];if(a){if(!a.type.startsWith("image/")){m.error("Please upload an image file");return}if(a.size>5*1024*1024){m.error("File size must be less than 5MB");return}N(!0);try{const t=`chat/${n}/${Date.now()}_${a.name}`,i=q(H,t);await T(i,a);const d=await $(i);o.mutate({type:"image",imageUrl:d})}catch(t){console.error("Upload error:",t),m.error("Failed to upload image")}finally{N(!1)}}},A=s=>{const a=s.senderId===(u==null?void 0:u.uid);return e.jsxs("div",{className:x("flex gap-2 mb-4",a?"flex-row-reverse":""),children:[!a&&e.jsx(_,{name:s.senderName,size:"sm",className:"flex-shrink-0"}),e.jsxs("div",{className:x("max-w-[70%]",a?"items-end":"items-start"),children:[!a&&e.jsx("p",{className:"text-xs text-secondary-500 mb-1",children:s.senderName}),e.jsxs("div",{className:x("rounded-2xl px-4 py-2",a?"bg-primary-600 text-white rounded-br-none":"bg-secondary-100 text-secondary-900 rounded-bl-none"),children:[s.type==="text"&&e.jsx("p",{className:"whitespace-pre-wrap break-words",children:s.text}),s.type==="image"&&e.jsx("img",{src:s.imageUrl,alt:"Shared image",className:"max-w-full rounded-lg"}),s.type==="order"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsx("span",{children:"Shared an order"})]}),s.type==="bill"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{children:"Shared a bill"})]})]}),e.jsx("p",{className:x("text-xs text-secondary-400 mt-1",a?"text-right":"text-left"),children:D(s.createdAt)})]})]},s.id)};return n?e.jsx(b,{children:e.jsxs(w,{className:"h-[calc(100vh-140px)] flex flex-col",children:[e.jsx(W,{className:"border-b border-secondary-200",children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-5 w-5"}),"House Chat"]})}),e.jsx(v,{className:"flex-1 overflow-y-auto p-4",children:C?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(F,{})}):p.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-secondary-500",children:[e.jsx(f,{className:"h-12 w-12 mb-3 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm",children:"Start the conversation!"})]}):e.jsxs(e.Fragment,{children:[p.map(A),e.jsx("div",{ref:j})]})}),e.jsx("div",{className:"p-4 border-t border-secondary-200",children:e.jsxs("form",{onSubmit:I,className:"flex gap-2",children:[e.jsxs("label",{className:"p-2 text-secondary-500 hover:text-secondary-700 cursor-pointer",children:[e.jsx(Z,{className:"h-5 w-5"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:R,disabled:M})]}),e.jsx("input",{type:"text",value:l,onChange:s=>g(s.target.value),placeholder:"Type a message...",className:"flex-1 input",disabled:o.isPending}),e.jsx(X,{type:"submit",disabled:!l.trim()||o.isPending,children:e.jsx(ee,{className:"h-5 w-5"})})]})})]})}):e.jsx(b,{children:e.jsx(w,{children:e.jsxs(v,{className:"py-12 text-center",children:[e.jsx(f,{className:"h-16 w-16 mx-auto mb-4 text-secondary-300"}),e.jsx("h3",{className:"text-lg font-medium text-secondary-900 mb-2",children:"No House Chat Available"}),e.jsx("p",{className:"text-secondary-500",children:"You need to be part of a house to access the chat feature."})]})})})}export{ce as default};
